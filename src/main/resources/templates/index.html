<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Навигационная панель</title>
    <link rel="stylesheet" href="/css/indexStyle.css">
    <link rel="stylesheet" href="/css/navbarStyle.css">
</head>
<body>
<div class="navbar">
    <div class="left">
        <a href="/">Главная</a>
        <a href="orders" id="ordersButton">Заказы</a>
    </div>
    <div class="user-info">
        <a href="/account/{login}"><p>Логин: <span id="login"></span></p></a>
        <div class="popup">
            <p><strong>Роль:</strong> <span id="role"></span></p>
            <p><strong>Имя:</strong> <span id="firstName"></span></p>
            <p><strong>Фамилия:</strong> <span id="lastName"></span></p>
            <p><strong>Отчество:</strong> <span id="middleName"></span></p>
            <p><strong>Почта:</strong> <span id="email"></span></p>
        </div>
    </div>
    <div>
        <a href="/cart" id="cartButton" style="display:none;">Корзина</a> <!-- initially hidden -->
    </div>
    <div>
        <a href="/login" id="loginButton">Войти</a>
        <a href="/register" id="registerButton">Зарегистрироваться</a>
        <a href="/logout" id="logoutButton" style="display:none;">Выйти</a>
    </div>
</div>
<div class="content">
    <h2>Каталог</h2>
    <div class="product-list" id="productList"></div> <!-- Список книг в виде карточек -->
</div>

<script>
    // Скрипт для показа окна с информацией о пользователе при наведении на логин
    document.querySelector('.user-info').addEventListener('mouseenter', function() {
        document.querySelector('.popup').style.display = 'block';
    });
    document.querySelector('.user-info').addEventListener('mouseleave', function() {
        document.querySelector('.popup').style.display = 'none';
    });

    async function getLogin() {
        const response = await fetch('api/account');
        const fetchedAccount = await response.json();
        const login = document.getElementById('login');
        const firstName = document.getElementById('firstName');
        const lastName = document.getElementById('lastName');
        const middleName = document.getElementById('middleName');
        const role = document.getElementById('role');
        const email = document.getElementById('email');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const logoutButton = document.getElementById('logoutButton');
        const cartButton = document.getElementById('cartButton'); // Get cart button
        const accountLink = document.querySelector('.user-info a'); // Находим ссылку на профиль

        // Привязываем данные пользователя к полям
        login.textContent = fetchedAccount?.login || 'Не авторизован';
        firstName.textContent = fetchedAccount?.firstName || 'Не указано';
        lastName.textContent = fetchedAccount?.lastName || 'Не указано';
        middleName.textContent = fetchedAccount?.middleName || 'Не указано';
        email.textContent = fetchedAccount?.email || 'Не указано';
        role.textContent = 'Не указано';
        if (fetchedAccount?.role == "ROLE_USER") {
            role.textContent = 'Покупатель';
        }
        else if (fetchedAccount?.role == "ROLE_CONSUMER") {
            role.textContent = 'Продавец';
        }
        else {
            role.textContent = 'Админ';
        }

        window.userRole = fetchedAccount?.role || null;

        // Логика отображения кнопок
        if (fetchedAccount?.login) {
            accountLink.href = `/account/${fetchedAccount.login}`;
            loginButton.style.display = 'none';
            registerButton.style.display = 'none';
            logoutButton.style.display = 'inline';
            cartButton.style.display = 'inline'; // Show cart button for logged-in users
        } else {
            loginButton.style.display = 'inline';
            registerButton.style.display = 'inline';
            logoutButton.style.display = 'none';
            cartButton.style.display = 'none'; // Hide cart button for non-logged-in users
        }

        if (fetchedAccount?.role === "ROLE_USER") {
            cartButton.style.display = 'inline';
            ordersButton.style.display = 'inline';
        } else {
            cartButton.style.display = 'none';
            ordersButton.style.display = 'none';
        }
    }

    async function loadProducts() {
        const response = await fetch('api/products');
        const products = await response.json();
        const productList = document.getElementById('productList');
        // Очищаем список перед добавлением новых данных
        productList.innerHTML = '';
        // Добавляем каждую книгу в виде карточки
        products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.classList.add('product-card');
            productCard.innerHTML = `
                <a href="products/${product.id}">
                    <img src="${product.imageUrl}" alt="${product.name}"/> <!-- Фото товара -->
                </a>
                <a href="products/${product.id}">
                    <h3>${product.name}</h3> <!-- Название товара -->
                </a>
                <p class="aag">${product.category.name}</p>
                <p>Цена: ${product.price} ₽</p>
                <button class="add-to-cart" data-product-id="${product.id}">Добавить в корзину</button>
            `;
            productList.appendChild(productCard);
        });

        if (window.userRole !== "ROLE_USER") {
            document.querySelectorAll('.add-to-cart').forEach(btn => btn.style.display = 'none');
        }

        // Обработчик кнопки "Добавить в корзину"
        document.querySelectorAll('.add-to-cart').forEach(button => {
            button.addEventListener('click', async function() {
                const productId = this.getAttribute('data-product-id');
                try {
                    const response = await fetch(`/api/cart/addtocart/${productId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // Если требуется авторизация, добавьте токен в заголовки
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        credentials: 'include' // Если используете куки для аутентификации
                    });

                    if (response.ok) {
                        console.log('Книга добавлена в корзину:', productId);
                        alert('Книга успешно добавлена в корзину!');
                    } else {
                        console.error('Ошибка при добавлении книги в корзину:', response.statusText);
                        alert('Произошла ошибка при добавлении книги в корзину.');
                    }
                } catch (error) {
                    console.error('Ошибка при отправке запроса:', error);
                    alert('Произошла ошибка при отправке запроса.');
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        getLogin();
        loadProducts();
    });
</script>
</body>
</html>